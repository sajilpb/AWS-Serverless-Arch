<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Simple EC2 Control</title>
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; max-width: 720px; margin: 2rem auto; }
      button { margin-right: 0.5rem; }
      pre { background: #f6f8fa; padding: 0.75rem; overflow: auto; }
    </style>
  </head>
  <body>
    <h1>EC2 Control</h1>
    <div id="auth">
      <button id="login">Login</button>
      <button id="logout" style="display:none">Logout</button>
    </div>

    <div id="actions" style="display:none">
      <button id="create">Create EC2 Instance</button>
      <button id="delete">Delete My Instances</button>
    </div>

    <pre id="out"></pre>

    <script>
    // API base URL (no Cognito details stored here)
    // Replace the value below with your API Gateway endpoint (terraform output `api_base_url`).
    // Example: 'https://abc123.execute-api.us-east-1.amazonaws.com'
    const API_BASE = 'https://xrdxjz10oi.execute-api.us-east-1.amazonaws.com';

    function parseTokenFromHash() {
      if (location.hash && location.hash.startsWith('#')) {
        const h = new URLSearchParams(location.hash.substring(1));
        const token = h.get('access_token');
        if (token) {
          localStorage.setItem('access_token', token);
          // clear hash for cleanliness
          history.replaceState({}, document.title, location.pathname + location.search);
        }
      }
      return localStorage.getItem('access_token');
    }

    async function api(path, options={}) {
      const token = localStorage.getItem('access_token');
      if (!token) throw new Error('Not authenticated');
      if (!API_BASE) throw new Error('API not configured');
      const res = await fetch(`${API_BASE}${path}`, {
        ...options,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          ...(options.headers || {})
        }
      });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }
      return { status: res.status, data };
    }

    const out = document.getElementById('out');
    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    const actions = document.getElementById('actions');
    const createBtn = document.getElementById('create');
    const deleteBtn = document.getElementById('delete');

    function renderAuthState() {
      const token = localStorage.getItem('access_token');
      if (token) {
        loginBtn.style.display = 'none';
        logoutBtn.style.display = '';
        actions.style.display = '';
      } else {
        loginBtn.style.display = '';
        logoutBtn.style.display = 'none';
        actions.style.display = 'none';
      }
    }

    loginBtn.onclick = () => {
      if (!API_BASE || API_BASE.includes('REPLACE_WITH_API_BASE')) {
        out.textContent = 'API not configured. Set API_BASE in index.html.';
        return;
      }
      window.location.href = `${API_BASE}/login`;
    };

    logoutBtn.onclick = () => {
      if (!API_BASE || API_BASE.includes('REPLACE_WITH_API_BASE')) {
        out.textContent = 'API not configured. Set API_BASE in index.html.';
        return;
      }
      // Clear local token then redirect to Hosted UI logout via API
      localStorage.removeItem('access_token');
      window.location.href = `${API_BASE}/logout`;
    };

    createBtn.onclick = async () => {
      out.textContent = 'Creating instance...';
      try {
        const { status, data } = await api('/create-ec2', { method: 'POST', body: JSON.stringify({}) });
        out.textContent = 'HTTP status: ' + status + '\n' + JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = 'Error: ' + e;
      }
    };
    deleteBtn.onclick = async () => {
      out.textContent = 'Deleting your instances...';
      try {
        const { status, data } = await api('/instances', { method: 'DELETE' });
        out.textContent = 'HTTP status: ' + status + '\n' + JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = 'Error: ' + e;
      }
    };

    // On load, capture token and update UI
    parseTokenFromHash();
    renderAuthState();
    // No list endpoint; you can paste the Instance ID to delete.
    </script>
  </body>
  </html>
